\subsubsection{Servidor}

Os servidores têm como função guardar e alterar os objectos partilhados, deste modo podem ser vistos como um repositório. Têm responsabilidade de se registar no mestre assim que estejam activos. Quando um objecto é alterado com sucesso, é da responsabilidade do servidor encaminhar essa informação até ao coordenador dessa transacção. O servidor tem disponíveis métodos de criação, leitura e escrita de objectos. O servidor guarda os objectos num vector, onde o índice do vector é o id do objecto. 

Existe uma \textit{thread} de baixa prioridade que de 10 em 10 segundos verifica o peso do próprio servidor. Se esse peso atingir um máximo definido (por optimização, é um valor variável) o servidor avisa o \textit{master} que está sobrecarregado. Cada vez que é verificado o peso do servidor, essa variável é colocada a 0. 

Existe também outra \textit{thread} de baixa prioridade que corre no fim de ter ocorrido uma restruturação dos dados num servidor devido à entrada de um novo servidor, e que é responsável por marcar os dados que serão apagados ou migrados quando entrar um novo servidor, de modo a que a entrada de um novo servidor termine o mais rapidamente possível. Cada PadInt contém um enum\{DELETE, MIGRATE, NONE\}, que é alterado pela \textit{thread} responsável pela marcação. Deste modo, prevê-se sempre que os dados serão migrados para um novo servidor, caso venha a aparecer. Isto garante que a fórmula utilizada para encontrar os objectos nos vários servidores funciona sempre, mesmo que o número de servidores varie ao longo do tempo.

O tipo PadInt é composto, além do seu valor numérico, por um \textit{mutex} e por um contador de acessos e pelo \textit{timestamp} da última versão que fez \textit{commit} com sucesso. Este objecto é guardado num vector, em que o índice é a posição correspondente ao uid desse objecto. Cada servidor guarda uma tabela de dispersão criada especificamente para gerir intervalos de ids onde guarda todos os objectos que lhe foram atribuídos.

Cada coordenador transaccional gere ainda um conjunto de tentativas transaccionais para quando tentar fazer \textit{commit} ter essa informação disponível. Esta informação é também útil caso outras transacções necessitem dos dados que ainda não tenham feito \textit{commit} (para saberem que têm que esperar ao invés de abortar). 

Para o servidor detectar os objectos especiais (que têm uma elevada taxa de acesso) usa um critério relacionado com a um número considerado limite máximo de acessos a um objecto. Este valor é variável conforme os testes feitos ao sistema e optimizado para o melhor desempenho possível. Se dois objectos num determinado servidor excederem esse valor, considera-se que os dois objectos em questão são especiais. Quando isto acontece, o \textit{master} é notificado para proceder ao balanceamento de carga por outros servidores. Isto significa que um desses objectos é escolhido aleatoriamente para ser mudado de servidor. Os servidores verificam esta situação em cada acesso (\textit{read} ou \textit{write}) e caso tal se verifique, a situação é reportada ao \textit{master}.
