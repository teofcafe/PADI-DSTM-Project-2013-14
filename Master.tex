\subsubsection{\textit{Master}}

\begin{description}

\item[Distribuição de \textit{timestamps}:]
O \textit{\textit{master}} ao receber um pedido do cliente, seja de criação ou de acesso, tem como função encaminhar o cliente para o servidor responsável por coordenar esta futura transacção. Deste modo, o \textit{master} não é sobrecarregado com as tarefas de coordenação transaccional. Por outro lado, ao encaminhar o cliente para um dos coordenadores transaccionais, entrega um \textit{timestamp} a esse cliente, para que este último o entregue ao servidor responsável pela coordenação da transacção que vai estar associada ao pedido em questão. Este processo de entrega de \textit{timestamps} pelo \textit{master} faculta uma ordem de acesso universal para o caso de diferentes transacções acederem ao mesmo objecto, deste modo todos os coordenadores criam as transacções com o \textit{timestamp} dado pelo \textit{master}.

\item[Escolha de coordenadores:]
Inicialmente, para a escolha do coordenador, o \textit{master} selecciona um dos servidores aleatoriamente, sendo que este instante de tempo (momento em que é escolhido o primeiro coordenador) corresponde ao primeiro pedido do cliente. Consoante são recebidos novos pedidos dos clientes, são escolhidos (pelo \textit{master}) servidores para serem coordenadores das novas transacções (entre os que ainda não foram escolhidos). Deste modo, algures no tempo, todos os servidores estarão a contribuir com trabalho de coordenação transaccional. Nessa altura a distribuição de transacções pelos coordenadores é distribuída de modo aleatório. Quando algum dos servidores notifica o \textit{master} que está  sobrecarregado, o \textit{master} descarta-o como opção para coordenador até que receba uma notificação do mesmo servidor a avisar que já se encontra pronto para coordenar novamente.

\item[Caso crítico:]
Quando todos os servidores disponíveis notificam o \textit{master} que estão sobrecarregados, então nesse caso, em específico, o \textit{master} torna a iniciativa de ser o coordenador de todas as próximas transacções até que exista pelo menos um servidor que consiga coordenador. De modo a impedir que o \textit{master} se torne \textit{bottleneck} quando este está a fazer trabalho de coordenação transaccional, é imposto um valor limite de carga, que é variável conforme os teste efectuados ao sistema de modo a optimizar o mesmo. Este valor limite tem em conta o peso das operações de coordenar cada transacção (peso 1), o peso de uma leitura (peso 2) e o peso de uma escrita (peso 3). Quando este valor é atingido, o \textit{master} rejeita pedidos de forma a manter-se funcional em relação aos pedidos sobre os quais já tem responsabilidade. Esta noção de pesos é aplicada também aos servidores, para saber se estão sobrecarregados e avisarem o \textit{master}, como referido anteriormente.

\item[Registo de novos servidores e localização de objectos:]
O \textit{master} tem ainda como função permitir o registo de novos servidores, dando ordem de redistribuição de armazenamento se tal vier a acontecer. Além disto, o \textit{master} decide em que servidor vão ser criados os novos objectos resultantes dos pedidos dos clientes. A decisão é baseada numa fórmula que tenta dividir ao máximo, de forma equivalente, a carga total de armazenamento pelos servidores. Deste modo, o id do servidor em que vai ser criado o novo objecto é igual ao resultado de \textit{(hash(uid) mod n)}, onde n corresponde ao número de servidores. Para guardar o objecto primário, sem ter em conta a réplica, a função de \textit{hash(uid)} devolve o próprio uid. Esta fórmula serve também para aceder a objectos já existentes, e nesse caso o uid corresponde ao uid do objecto a que se quer aceder.

\item[Objectos especiais:]
A fórmula anterior é válida para todos os objectos, excepto para aqueles são extremamente acedidos e residem no mesmo servidor. Estes são designados por objectos especiais. Para estes objectos é guardado no \textit{master} a sua localização real, visto que a fórmula não iria resultar neste caso. Deste modo, antes de executar a fórmula para saber onde está o objecto, verifica-se se o mesmo é um objecto especial. Isto é feito a partir da tentativa de acesso ao objecto em questão numa tabela de dispersão. Caso o acesso seja feito com sucesso (o objecto está na tabela e portanto é especial) a localização real é devolvida, caso contrário é devolvido \textit{null} e sabemos que temos que encontrar a localização a partir da fórmula genérica.

\item[Actualização dos servidores pelo \textit{master}:]
Sempre que um servidor é criado, o \textit{master} fornece-lhe a informação relativa a esta fórmula. Do mesmo modo, cada vez que um novo servidor aparece no sistema ou um objecto é considerado especial, essa informação tem que ser actualizada. Deste modo, à medida que os servidores tentam aceder à informação não actualizada é apresentado um erro. Quando os servidores se deparam com este erro, requisitam a informação ao \textit{master} e nesse momento têm acesso á informação actualizada.  A partir do momento que o servidor se regista no \textit{master},  pode também ser escolhido para ser coordenador, visto que a selecção se dá de forma aleatória entre todos os servidores.
Para facilitar o trabalho do \textit{master}, este guarda na tabela (vector) de correspondência entre o ID dos servidores e os respectivos endereços IP. Esta informação é enviada para o coordenador caso o mesmo faça um pedido para tal. De modo a diminuir o número de pedidos, cada coordenador tem uma \textit{cache} de 100 entradas para este efeito.

\begin{table}
\centering
\begin{tabular}{c|c}
ID do Servidor & IP do Servidor \\\hline
0 & tcp : // 192.168.2.72:80 /Server \\
1 & tcp : // 192.168.2.73:80 /Server \\
2 & tcp : // 192.168.2.74:80 /Server \\
3 & tcp : // 192.168.2.75:80 /Server \\
\end{tabular}
\caption{\label{tab:idip}Tradução ID-IP dos servidores.}
\end{table}
\end{description}